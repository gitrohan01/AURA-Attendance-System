{% extends "attendance/base.html" %}
{% block title %}Teacher Analytics — AURA{% endblock %}

{% block content %}

<h1 class="text-3xl font-bold text-sky-400 mb-6">
    Teacher Analytics — {{ teacher.get_full_name|default:teacher.username }}
</h1>

<!-- TOP SUMMARY CARDS -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">

    <div class="bg-white/5 border border-white/10 rounded-xl p-4">
        <div class="text-xs uppercase tracking-wide text-gray-400 mb-1">
            Total Sessions
        </div>
        <div class="text-2xl font-bold">{{ total_sessions }}</div>
    </div>

    <div class="bg-white/5 border border-white/10 rounded-xl p-4">
        <div class="text-xs uppercase tracking-wide text-gray-400 mb-1">
            Avg Attendance
        </div>
        <div class="text-2xl font-bold text-sky-400">{{ avg_attendance }}%</div>
    </div>

    <div class="bg-white/5 border border-white/10 rounded-xl p-4">
        <div class="text-xs uppercase tracking-wide text-gray-400 mb-1">
            Present Records
        </div>
        <div class="text-2xl font-bold text-emerald-400">{{ total_present }}</div>
    </div>

    <div class="bg-white/5 border border-white/10 rounded-xl p-4">
        <div class="text-xs uppercase tracking-wide text-gray-400 mb-1">
            Absent Records
        </div>
        <div class="text-2xl font-bold text-red-400">{{ total_absent }}</div>
    </div>

</div>

<!-- LAYOUT: LEFT = WEEKLY CHART, RIGHT = RECENT SESSIONS -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- WEEKLY CHART -->
    <div class="bg-white/5 border border-white/10 rounded-xl p-5">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-semibold">Last 7 Days Attendance</h2>
            <span class="text-xs text-gray-400">
                For {{ teacher.username }}
            </span>
        </div>
        <canvas id="teacherWeeklyChart" height="140"></canvas>
    </div>

    <!-- RECENT SESSIONS -->
    <div class="bg-white/5 border border-white/10 rounded-xl p-5">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-semibold">Recent Sessions</h2>
            <span class="text-xs text-gray-400">
                Showing last {{ sessions|length }} sessions
            </span>
        </div>

        <div class="max-h-80 overflow-y-auto">
            {% if sessions %}
                <table class="min-w-full text-sm">
                    <thead class="text-left text-gray-300">
                        <tr>
                            <th class="py-1 pr-4">Session ID</th>
                            <th class="py-1 pr-4">Class</th>
                            <th class="py-1 pr-4">Subject</th>
                            <th class="py-1 pr-4">Start</th>
                            <th class="py-1 pr-4">End</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in sessions %}
                            <tr class="border-t border-white/5">
                                <td class="py-1 pr-4 text-xs">{{ s.session_id }}</td>
                                <td class="py-1 pr-4 text-xs">{{ s.class_group.name }}</td>
                                <td class="py-1 pr-4 text-xs">{{ s.subject.code }}</td>
                                <td class="py-1 pr-4 text-xs">{{ s.start_time|date:"d M, H:i" }}</td>
                                <td class="py-1 pr-4 text-xs">
                                    {% if s.end_time %}
                                        {{ s.end_time|date:"d M, H:i" }}
                                    {% else %}
                                        <span class="text-yellow-400">Ongoing</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-gray-400 text-sm">No sessions recorded yet.</p>
            {% endif %}
        </div>
    </div>

</div>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
    const url = "{% url 'hod_teacher_weekly_stats' teacher.id %}";

    fetch(url)
      .then(r => r.json())
      .then(data => {
        const ctx = document.getElementById("teacherWeeklyChart").getContext("2d");

        new Chart(ctx, {
          type: "line",
          data: {
            labels: data.labels,
            datasets: [
              {
                label: "Present",
                data: data.present,
                borderWidth: 2,
                borderColor: "rgb(34,197,94)",
                tension: 0.3,
                fill: false
              },
              {
                label: "Absent",
                data: data.absent,
                borderWidth: 2,
                borderColor: "rgb(248,113,113)",
                tension: 0.3,
                fill: false
              }
            ]
          },
          options: {
            plugins: {
              legend: {
                labels: {
                  color: "#e5e7eb"
                }
              }
            },
            scales: {
              x: {
                ticks: { color: "#9ca3af" },
                grid: { color: "rgba(148,163,184,0.15)" }
              },
              y: {
                ticks: { color: "#9ca3af" },
                grid: { color: "rgba(148,163,184,0.15)" }
              }
            }
          }
        });
      })
      .catch(err => console.error("Chart load error", err));
})();
</script>

{% endblock %}
