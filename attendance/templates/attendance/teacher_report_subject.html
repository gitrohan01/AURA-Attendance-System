{% extends "attendance/base.html" %}
{% block title %}Subject Report ‚Äî AURA{% endblock %}

{% block content %}

<h1 class="text-2xl font-bold text-sky-400 mb-6">
    üìò Subject Report ‚Äî {{ subject.name }} ({{ subject.code }})
</h1>

<!-- SUMMARY CARDS -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

    <!-- Total Sessions -->
    <div class="p-5 bg-white/5 rounded-xl border border-white/10">
        <h3 class="text-gray-300 text-sm">Total Sessions</h3>
        <p class="text-3xl font-semibold">{{ sessions.count }}</p>
    </div>

    <!-- Last 30 Days Avg -->
    <div class="p-5 bg-white/5 rounded-xl border border-white/10">
        <h3 class="text-gray-300 text-sm">Last 30 Days Attendance</h3>
        <p class="text-xl font-semibold text-sky-400" id="avg30">Loading...</p>
    </div>

    <!-- Export Options -->
    <div class="p-5 bg-white/5 rounded-xl border border-white/10">
        <h3 class="text-gray-300 text-sm">Export Options</h3>

        <div class="flex flex-col mt-2 space-y-2">
            <a href="{% url 'export_subject_csv' subject.id %}"
               class="px-3 py-2 text-center bg-blue-600 hover:bg-blue-700 rounded">
                üìÑ Export CSV
            </a>

            <a href="{% url 'export_subject_xlsx' subject.id %}"
               class="px-3 py-2 text-center bg-green-600 hover:bg-green-700 rounded">
                üìä Export XLSX
            </a>

            <a href="{% url 'export_subject_pdf' subject.id %}"
               class="px-3 py-2 text-center bg-red-600 hover:bg-red-700 rounded">
                üìù Export PDF
            </a>
        </div>
    </div>

</div>

<!-- 30-DAY TREND CHART -->
<div class="bg-white/5 p-6 rounded-xl border border-white/10 mb-10">
    <h2 class="font-semibold mb-4">Last 30 Days Attendance Trend</h2>
    <canvas id="subjectChart" height="120"></canvas>
</div>

<!-- SESSION LIST -->
<div class="bg-white/5 p-6 rounded-xl border border-white/10">
    <h2 class="text-xl font-semibold mb-4">Sessions</h2>

    {% if sessions %}
    <table class="min-w-full text-left text-sm">
        <thead>
            <tr class="text-gray-400 border-b border-white/10">
                <th class="py-2">Session ID</th>
                <th class="py-2">Class</th>
                <th class="py-2">Start</th>
                <th class="py-2">End</th>
                <th class="py-2">Exports</th>
            </tr>
        </thead>

        <tbody>
            {% for s in sessions %}
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="py-2">{{ s.session_id }}</td>
                <td class="py-2">{{ s.class_group.name }}</td>
                <td class="py-2">{{ s.start_time|date:"Y-m-d H:i" }}</td>

                <td class="py-2">
                    {% if s.end_time %}
                        {{ s.end_time|date:"Y-m-d H:i" }}
                    {% else %}
                        <span class="text-orange-400">Ongoing</span>
                    {% endif %}
                </td>

                <td class="py-2 space-x-1">
                    <a href="{% url 'session_export_csv' s.id %}"
                       class="px-2 py-1 bg-blue-600 rounded text-xs">CSV</a>

                    <a href="{% url 'session_export_xlsx' s.id %}"
                       class="px-2 py-1 bg-green-600 rounded text-xs">XLSX</a>

                    <a href="{% url 'session_export_pdf' s.id %}"
                       class="px-2 py-1 bg-red-600 rounded text-xs">PDF</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% else %}
    <p class="text-gray-400">No sessions found.</p>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
fetch("/api/teacher/subject/{{ subject.id }}/stats/")
    .then(res => res.json())
    .then(data => {

        // Set average 30-day attendance
        document.getElementById("avg30").textContent = data.average_30 + "%";

        // Build the chart
        new Chart(document.getElementById("subjectChart"), {
            type: "line",
            data: {
                labels: data.days,
                datasets: [
                    {
                        label: "Present",
                        data: data.present,
                        borderWidth: 2,
                        borderColor: "rgb(34,197,94)",
                        tension: 0.3
                    },
                    {
                        label: "Absent",
                        data: data.absent,
                        borderWidth: 2,
                        borderColor: "rgb(239,68,68)",
                        tension: 0.3
                    }
                ]
            }
        });
    });
</script>

{% endblock %}
